# Payment Init
- -----Server receives the [product_id] + [product_amount] + [payment_method] + [idempotency_key]
 via [/api/payments/initiate]endpoint 
------> server validate the request payloads via the [InitiatePaymentRequest] validation layer 
------> insure that it is a unique request via [IdempotencyMiddleware] that check if the idem.. 
key exiest in the cache or not 
------> validate the product exists, price, is purchasable 
------> build the payment draft DB table and set the payment states: "pending"

- [Idempotency] Generated by the frontend, prevent request duplication  

- Depending on the payment method, I will trigger the [PaymentMethodRouter] class that issue the frontend response depending on the selected method:
    - If egyption methods (vodavon cash, Fawry, EGP currency) -→ route to Paymob/Fawry . . [LocalMethods]
    - If universal methods and supporting multi currencies = -→  route to PayPal/Stripe . . [PayPalMethod]
    - ..... Extensibility: New services can be added to the router for future methods (e.g., Apple Pay, Google Pay).

# Server Communicates with the PSP (Payment service provider) API
- Initiate PSP Transaction: The selected service (e.g., PaymobService) calls its respective
    PSP's   external API (e.g., Paymob's API endpoint [POST] /[acceptance/payments/pay])
    to register the transaction.



- [PaypalGetway] ---> post [clientSecret] [clientId] to the paypal API endpont 
    [https://api-m.paypal.com/v1/oauth2/token] to generate the accessToken 
    ---> post payment order details with the accessToken to the [https://api-m.paypal.com/v2/checkout/orders] to create payment order and return the payment [links] and send it to the frontend 

- [PaymobGet] ---> post [apiKey]
    to Paymob authentication endpoint
    [https://accept.paymob.com/api/auth/tokens]
    to generate the authToken used for all subsequent Paymob operations.

    ---> post order registration payload [amount_cents] + [currency]
    with [authToken] to [https://accept.paymob.com/api/ecommerce/orders]
    to create a Paymob order and receive an internal Paymob [orderId].

    ---> post payment key request [orderId] + [integrationId] + [billingData]
    with [authToken] to [https://accept.paymob.com/api/acceptance/payment_keys]
    to generate the payment_key required for Paymob's iframe checkout.

    ---> construct final iframe URL using:
    [https://accept.paymob.com/api/acceptance/iframes/{iframeId}?payment_token={payment_key}]
    and return it to the frontend so the client can render Paymob’s payment widget.




- Server Receives PSP Response: The server receives a response from the PSP API containing the necessary action instructions.
- Database Update: The server updates the payment_draft record with the PSP's [transaction-reference-id] and sets the state to "awaiting_user_action".

# Server Responds to Frontend
- Server Response to Frontend: The server responds to the initial [/api/payments/initiate] request with a standardized response object for the client-side UI to interpret --> Frontend receives: [paymentDraftId], [paymentAction], [actionData].

- [paymentAction] dictates the frontend UI flow:
    - redirect_url: The user needs to be sent to a hosted payment page (common for card payments, sometimes PayPal).
    - qr_code: A QR code needs to be displayed (common for some Fawry flows).
    - reference_code: A simple text code needs to be displayed for the user to manually pay in a physical store (common for Fawry cash payments).
    - otp_token / mobile_prompt: A prompt on the user's mobile app is required (common for Vodafone Cash/E-wallets).

- Frontend Switches UI: The frontend switches to the corresponding payment UI automatically based on [paymentAction].

# User Interaction & Asynchronous Status Management (Webhooks)
- User Completes Payment: The user interacts with their specific UI (e.g., scans QR code, enters OTP, pays at agent, completes card form).
- PSP Notifies Your Server (Webhook): This is a critical asynchronous step. The PSP's server calls a separate dedicated endpoint on your backend (e.g., [POST] /api/payments/webhook-handler).

- Webhook Handler:
    - Receives the payment status notification ("paid", "failed", "refunded").
    - Verifies the integrity of the notification (using a shared secret or signature).
    - Uses the [transaction-reference-id] to find and update the payment_draft record to the final state ("completed" or "failed").

# Order Fulfillment and Final Confirmation
- Order Fulfillment Logic: Once the payment_draft state is "completed", your backend system triggers the order fulfillment process (e.g., ships the product, grants access to digital content).

- Client-Side Polling (Optional for UX): The frontend can "poll" (periodically check) a status endpoint (e.g., [GET] /api/payments/status/{paymentDraftId}) to provide immediate feedback to the user without them needing to refresh the page.

- Final UI Update: The frontend receives the final "completed" status and displays the "Payment Successful" screen.



